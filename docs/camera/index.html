<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FOTO FIT</title>
  <style>
    body{font-family:system-ui,-apple-system,Arial;margin:0;background:#0b1220;color:#fff}
    .wrap{max-width:520px;margin:0 auto;padding:14px}
    h1{font-size:18px;margin:8px 0 12px}
    .box{background:#111b33;border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
    video, img{width:100%;display:block;background:#000}
    .btns{display:grid;gap:10px;margin-top:12px}
    button{
      width:100%;padding:14px 12px;border-radius:14px;border:0;
      font-weight:900;font-size:16px;cursor:pointer
    }
    .p{background:#2f6bff;color:#fff}
    .s{background:#1c2a52;color:#fff;border:1px solid rgba(255,255,255,.12)}
    .d{background:#3b4256;color:#cdd5ff}
    .msg{margin-top:10px;font-size:14px;color:#cdd5ff}
    .small{font-size:12px;opacity:.85;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∏ FOTO FIT</h1>

    <div class="box">
      <video id="cameraPreview" playsinline muted autoplay></video>
      <img id="resultImg" style="display:none;" alt="Foto pronta">
    </div>

    <div class="btns">
      <button class="p" id="startCamera" type="button">Abrir C√¢mera</button>
      <button class="p" id="takePhoto" type="button">Tirar Foto</button>
      <button class="s" id="saveBtn" type="button" disabled>Salvar / Compartilhar</button>
      <button class="d" id="retryBtn" type="button" style="display:none;">Tirar outra</button>
    </div>

    <div class="msg" id="status">Abra a c√¢mera e depois clique em Tirar Foto.</div>
    <div class="small">Obs: No iPhone, ‚ÄúBaixar‚Äù direto quase sempre falha. Por isso o bot√£o salva via Compartilhar ‚úÖ</div>

    <canvas id="photoCanvas" style="display:none;"></canvas>
  </div>

  <script>
    const video = document.getElementById("cameraPreview");
    const canvas = document.getElementById("photoCanvas");
    const img = document.getElementById("resultImg");

    const startBtn = document.getElementById("startCamera");
    const takeBtn  = document.getElementById("takePhoto");
    const saveBtn  = document.getElementById("saveBtn");
    const retryBtn = document.getElementById("retryBtn");
    const statusEl = document.getElementById("status");

    let stream = null;
    let lastBlob = null;

    function setStatus(t){ statusEl.textContent = t; }

    async function startCamera(){
      try{
        setStatus("Abrindo c√¢mera‚Ä¶");
        if (stream) {
          stream.getTracks().forEach(t=>t.stop());
          stream = null;
        }

        const constraints = {
          video: { facingMode: { ideal: "environment" } },
          audio: false
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        // iPhone precisa de play() ap√≥s gesto do usu√°rio
        await video.play();

        // esperar o v√≠deo realmente ficar pronto
        await new Promise((resolve) => {
          if (video.readyState >= 2 && video.videoWidth > 0) return resolve();
          video.onloadedmetadata = () => resolve();
        });

        img.style.display = "none";
        video.style.display = "block";
        saveBtn.disabled = true;
        retryBtn.style.display = "none";
        setStatus("C√¢mera ligada ‚úÖ Agora clique em Tirar Foto.");
      }catch(e){
        console.log(e);
        setStatus("‚ùå N√£o deu permiss√£o. No iPhone: Ajustes > Safari > C√¢mera (Permitir).");
        alert("Permita a c√¢mera no Safari.");
      }
    }

    function drawWatermark(ctx, w, h){
      const pad = Math.round(w * 0.03);
      const fontSize = Math.max(22, Math.round(w * 0.06));

      ctx.font = `900 ${fontSize}px system-ui, -apple-system, Arial`;
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.strokeStyle = "rgba(0,0,0,0.40)";
      ctx.lineWidth = Math.max(2, Math.round(fontSize * 0.10));

      // 2 linhas: LP FIT TECH + TREINO PAGO
      const t1 = "LP FIT TECH";
      const t2 = "TREINO PAGO";

      const x = pad;
      const y1 = pad + fontSize;
      const y2 = y1 + Math.round(fontSize * 1.05);

      ctx.strokeText(t1, x, y1);
      ctx.fillText(t1, x, y1);

      ctx.strokeText(t2, x, y2);
      ctx.fillText(t2, x, y2);
    }

    async function takePhoto(){
      try{
        if (!stream || !video.srcObject){
          setStatus("Abra a c√¢mera primeiro.");
          alert("Abra a c√¢mera primeiro.");
          return;
        }

        // Se no iPhone ainda estiver 0, n√£o captura
        if (video.videoWidth === 0 || video.videoHeight === 0){
          setStatus("Aguarde 1 segundo e tente de novo (v√≠deo carregando).");
          return;
        }

        const w = video.videoWidth;
        const h = video.videoHeight;

        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, w, h);
        drawWatermark(ctx, w, h);

        // Converter pra Blob (melhor para iPhone)
        lastBlob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png", 1.0));

        // Mostrar preview
        const url = URL.createObjectURL(lastBlob);
        img.src = url;
        img.style.display = "block";
        video.style.display = "none";
        saveBtn.disabled = false;
        retryBtn.style.display = "block";

        setStatus("Foto pronta ‚úÖ Clique em Salvar / Compartilhar.");
      }catch(e){
        console.log(e);
        setStatus("‚ùå Erro ao tirar foto.");
        alert("Erro ao tirar foto.");
      }
    }

    async function saveShare(){
      if (!lastBlob){
        alert("Tire a foto primeiro.");
        return;
      }

      const file = new File([lastBlob], "lp-fit-foto.png", { type: "image/png" });

      // iPhone: melhor forma de salvar √© compartilhar -> Salvar Imagem
      if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share){
        try{
          await navigator.share({
            title: "Foto Fit",
            text: "LP FIT TECH ‚Ä¢ TREINO PAGO",
            files: [file]
          });
          setStatus("‚úÖ Use 'Salvar Imagem' no menu de compartilhamento.");
          return;
        }catch(e){
          // usu√°rio cancelou, tudo bem
          console.log(e);
        }
      }

      // Fallback: abrir em nova aba (a√≠ salva manualmente)
      const url = URL.createObjectURL(lastBlob);
      window.open(url, "_blank");
      setStatus("Abrindo a imagem‚Ä¶ (salve pela nova aba)");
    }

    function retry(){
      // voltar pra c√¢mera
      img.style.display = "none";
      video.style.display = "block";
      saveBtn.disabled = true;
      retryBtn.style.display = "none";
      setStatus("Pronto. Clique em Tirar Foto.");
    }

    startBtn.addEventListener("click", startCamera);
    takeBtn.addEventListener("click", takePhoto);
    saveBtn.addEventListener("click", saveShare);
    retryBtn.addEventListener("click", retry);
    // ===== Marca (imagem) =====
const watermarkImg = new Image();
watermarkImg.src = "./marca.png";

function drawWatermark(ctx, w, h){

  if (!watermarkImg.complete || watermarkImg.naturalWidth === 0){
    console.log("Logo ainda n√£o carregou");
    return;
  }

  const marcaWidth = w * 0.5;
  const marcaHeight = (watermarkImg.naturalHeight / watermarkImg.naturalWidth) * marcaWidth;

  ctx.globalAlpha = 0.9;
  ctx.drawImage(watermarkImg, 20, 20, marcaWidth, marcaHeight);
  ctx.globalAlpha = 1;
}
  </script>
</body>
</html>
